name: è‡ªåŠ¨éƒ¨ç½²åˆ° CF Worker

on:
  push:
    branches:
      - main
    paths:
      - '_worker.js'
      - 'wrangler.toml'
  workflow_dispatch:

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    env:
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      CF_D1_ID: ${{ secrets.CF_D1_ID }}

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ†™ å®‰è£…æœ€æ–° Wrangler
        run: npm install -g wrangler@latest

      - name: ğŸ”„ é…ç½®è§£æä¸å˜é‡æ›¿æ¢
        id: config_setup
        run: |
          if [ -z "${CF_D1_ID}" ]; then
            echo "::error title=âŒ éƒ¨ç½²å¤±è´¥::å¿…é¡»åœ¨ [Action Secrets] ä¸­è®¾ç½® 'CF_D1_ID'"
            exit 1
          fi
          sed -i "s#{CF_D1_ID}#${CF_D1_ID}#g" wrangler.toml

          WORKER_NAME=$(grep '^name =' wrangler.toml | awk -F '"' '{print $2}')
          if [ -z "$WORKER_NAME" ]; then
            echo "::error file=wrangler.toml,line=1,title=âŒ é…ç½®é”™è¯¯::æœªèƒ½åœ¨ [wrangler.toml] ä¸­æ‰¾åˆ° 'name' å­—æ®µ"
            exit 1
          fi

          echo "âœ… é¡¹ç›®åç§°: $WORKER_NAME"
          echo "worker_name=$WORKER_NAME" >> $GITHUB_OUTPUT

          echo -e "\n--- æ›¿æ¢åçš„ wrangler.toml ---"
          cat wrangler.toml
          echo "----------------------------"

      - name: âš™ï¸ åŠ¨æ€ç”Ÿæˆç¯å¢ƒå˜é‡åˆ—è¡¨
        id: dynamic_vars
        run: |
          VARS=""

          if [ -n "$USERNAME" ] && [ -n "$PASSWORD" ]; then
            VARS+="USERNAME"$'\n'"PASSWORD"$'\n'
            echo "âœ… å·²è½½å…¥ç™»å½•å‡­è¯é…ç½®"
          else
            echo "::warning title=âš ï¸ ç™»å½•é…ç½®ç¼ºå¤±::[Action Secrets] ä¸­æœªè®¾ç½® USERNAME/PASSWORDï¼Œé»˜è®¤å€¼å‡ä¸º admin"
          fi

          if [ -n "$TG_CHAT_ID" ] && [ -n "$TG_BOT_TOKEN" ]; then
            VARS+="TG_CHAT_ID"$'\n'"TG_BOT_TOKEN"$'\n'
            echo "âœ… å·²è½½å…¥ Telegram é€šçŸ¥é…ç½®"
          else
            echo "::warning title=âš ï¸ TG é€šçŸ¥æœªå¯ç”¨::[Action Secrets] ä¸­æœªè®¾ç½® TG_CHAT_ID/TG_BOT_TOKENï¼Œå°†æ— æ³•å‘é€é€šçŸ¥"
          fi

          if [ -n "$VARS" ]; then
            printf 'vars_list<<EOF\n%sEOF\n' "$VARS" >> "$GITHUB_OUTPUT"
          else
            printf 'vars_list=\n' >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸš€ éƒ¨ç½²åˆ° Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ vars.CF_ACCOUNT_ID }}
          vars: ${{ steps.dynamic_vars.outputs.vars_list }}

      - name: âœ¨ éƒ¨ç½²æ€»ç»“
        env:
          WORKER_NAME: ${{ steps.config_setup.outputs.worker_name }}
          ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        run: |
          echo ""
          echo "::notice title=ğŸš€ éƒ¨ç½²æˆåŠŸ::æ­å–œï¼æ‚¨çš„ [$WORKER_NAME] é¡¹ç›®å·²ä¸Šçº¿"
          echo "ğŸ”— CFç®¡ç†åå° (ç‚¹å‡»ç›´æ¥è·³è½¬):"
          echo "https://dash.cloudflare.com/${ACCOUNT_ID}/workers/services/view/${WORKER_NAME}/production/settings"
          echo ""
          echo "::warning title=âš ï¸ é‡è¦æç¤º::å¿…çœ‹ä»¥ä¸‹è¯´æ˜!!!"
          echo "-----------------------------------------------------"
          echo "ä¸ºäº†ç¡®ä¿é¡¹ç›®è¿è¡Œåœ¨æœ€ä½³çŠ¶æ€ï¼Œå»ºè®®å®Œæˆä»¥ä¸‹é…ç½®ï¼š"
          echo "ğŸš€ ç»‘å®šè‡ªå®šä¹‰åŸŸå"
          echo "ğŸš€ å¼€å¯ WebP å›¾ç‰‡è‡ªåŠ¨è½¬æ¢ (æ‰‹åŠ¨æ–°å¢ç¯å¢ƒå˜é‡):"
          echo "    - å˜é‡å: DOMAIN        å€¼: è‡ªå®šä¹‰åŸŸå"
          echo "    - å˜é‡å: WEBP_ENABLED  å€¼: true"
          echo "æ³¨æ„ï¼šå®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶è½¬æ¢ WebP æ ¼å¼"
          echo "-----------------------------------------------------"
          echo ""
          echo "::group::ğŸ’¡ å…¶ä»–å¯é€‰ç¯å¢ƒå˜é‡ï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹ï¼‰"
          echo "- API TOKEN: APIæ¥å£å¯†é’¥, é»˜è®¤ä¸º tgfile-admin, ç”¨äºè‡ªåŠ¨åŒ–é›†æˆ"
          echo "- COOKIE: COOKIEæœ‰æ•ˆæœŸ, é»˜è®¤ä¸º 7, å•ä½ï¼šå¤©"
          echo "- ENABLE_AUTH: æ˜¯å¦å¯ç”¨ç™»å½•, é»˜è®¤ä¸º true, å¯è®¾ç½®ä¸º false ç¦ç”¨ç™»å½•"
          echo "::endgroup::"
