name: è‡ªåŠ¨éƒ¨ç½²åˆ° CF Worker

on:
  push:
    branches:
      - main
    paths:
      - '_worker.js'
      - 'wrangler.toml'
  workflow_dispatch:

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    env:
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID}}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN}}
      CF_D1_ID: ${{ secrets.CF_D1_ID }}

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ†™ æ›´æ–°å¹¶å®‰è£…æœ€æ–° Wrangler
        run: npm install -g wrangler@latest

      - name: ğŸ”„ æ›¿æ¢ wrangler.toml ä¸­çš„å˜é‡
        id: config_setup
        run: |
          [ -n "${CF_D1_ID}" ] || { echo "ğŸ”´ é”™è¯¯: å¿…é¡»è®¾ç½® 'CF_D1_ID' å˜é‡"; exit 1; }  
          sed -i "s#{CF_D1_ID}#${CF_D1_ID}#g" wrangler.toml

          WORKER_NAME=$(grep '^name =' wrangler.toml | awk -F '"' '{print $2}')
          [ -n "$WORKER_NAME" ] || { echo "ğŸ”´ é”™è¯¯: æœªèƒ½åœ¨ wrangler.toml ä¸­æ‰¾åˆ° 'name' å­—æ®µ"; exit 1; }

          echo -e "\nğŸ‰ é¡¹ç›®é…ç½®ä¿¡æ¯å¦‚ä¸‹:"
          echo "-------------------"
          cat wrangler.toml
          echo "-------------------"
          echo "worker_name=$WORKER_NAME" >> $GITHUB_OUTPUT

      - name: âš™ï¸ åŠ¨æ€é…ç½® Worker ç¯å¢ƒå˜é‡
        id: dynamic_vars
        run: |
          VARS=""
          [ -n "$USERNAME" ] && [ -n "$PASSWORD" ] && VARS+="USERNAME"$'\n'"PASSWORD"$'\n' || echo "âš ï¸ è­¦å‘Š: USERNAME/PASSWORD å˜é‡æœªè®¾ç½®ï¼Œé»˜è®¤å‡ä¸º admin"
          [ -n "$TG_CHAT_ID" ] && [ -n "$TG_BOT_TOKEN" ] && VARS+="TG_CHAT_ID"$'\n'"TG_BOT_TOKEN"$'\n' || echo "âš ï¸ è­¦å‘Š: TG å˜é‡æœªè®¾ç½®ï¼Œæ— æ³•æ‰§è¡Œ TG é€šçŸ¥"

          if [ -n "$VARS" ]; then
            printf 'vars_list<<EOF\n%sEOF\n' "$VARS" >>"$GITHUB_OUTPUT"
            echo -e "\nâœ… ä¼ é€’ç»™ Wrangler çš„å˜é‡å:"
            printf '%s' "$VARS"
          else
            echo -e "\nâš ï¸ æ²¡æœ‰éœ€è¦ä¼ é€’çš„å˜é‡å"
            printf 'vars_list=\n' >>"$GITHUB_OUTPUT"
          fi

      - name: ğŸš€ éƒ¨ç½²åˆ° CF Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ vars.CF_ACCOUNT_ID }}
          vars: ${{ steps.dynamic_vars.outputs.vars_list }}

      - name: âœ¨ è¾“å‡º Worker ç®¡ç†åå°
        env:
          WORKER_NAME: ${{ steps.config_setup.outputs.worker_name }}
          ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        run: |
          echo -e "\nâœ¨âœ¨âœ¨ éƒ¨ç½²å®Œæˆ âœ¨âœ¨âœ¨"
          echo "ğŸŒ ç‚¹å‡»ä»¥ä¸‹é“¾æ¥å¯è®¿é—®é¡¹ç›®ç®¡ç†åå°"
          echo "https://dash.cloudflare.com/${ACCOUNT_ID}/workers/services/view/${WORKER_NAME}/production/settings"
          echo "ğŸš€ å»ºè®®: ç»™é¡¹ç›®ç»‘å®šä¸€ä¸ªè‡ªå®šä¹‰åŸŸå"
          echo "ğŸš€ æ‰‹åŠ¨æ–°å¢ç¯å¢ƒå˜é‡ DOMAIN, å€¼ä¸ºç»‘å®šçš„åŸŸå"
          echo "ğŸš€ æ‰‹åŠ¨æ–°å¢ç¯å¢ƒå˜é‡ WEBP_ENABLED, å€¼ä¸º true"
          echo "ğŸš€ å®Œæˆä»¥ä¸Šæ­¥éª¤ï¼Œæ–¹å¯å¼€å¯å›¾ç‰‡ webp çš„è‡ªåŠ¨è½¬æ¢"
